# Base image
FROM golang:1.21-bookworm AS build

# Set working directory
WORKDIR /home/toae/plugins/cloud-scanner

# Copy the plugin code
COPY plugins/cloud-scanner .

# Build the plugin (if needed)
# RUN go build -o cloud_scanner .

# Build image
FROM debian:bookworm-slim AS final_builder

# Install required packages
RUN apt-get update \
    && apt-get install -y --no-install-recommends bash git ca-certificates nano logrotate sudo \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Create the toae user and group
RUN groupadd -r toae && useradd -r -g toae toae

# Set environment variables
ENV DEEPFENCE_KEY=$TOAE_KEY \
    HOME_DIR="/home/toae" \
    COMPLIANCE_MOD_PATH="/opt/steampipe" \
    VERSION=2.1.0 \
    PUBLISH_CLOUD_RESOURCES_INTERVAL_MINUTES=5 \
    FETCH_CLOUD_RESOURCES_INTERVAL_HOURS=12

# Create directory /home/deepfence with correct permissions
RUN mkdir -p /home/deepfence && chown toae:toae /home/deepfence

# Installing FluentBit
RUN echo '%sudo ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

# Copy scripts and configurations
COPY start_cloud_agent.sh /entrypoint.sh
COPY etc/fenced_logrotate.conf /etc/logrotate.d/logrotate.conf

# Change permissions
RUN chmod +x /entrypoint.sh /etc/logrotate.d/logrotate.conf

# Set working directory
WORKDIR /opt/steampipe

# Create symbolic link for /home/deepfence
RUN ln -s /home/toae /home/deepfence

# Set user
USER toae

# Entry point
ENTRYPOINT ["/entrypoint.sh"]
CMD ["/usr/local/bin/cloud_scanner"]

# Copy plugin binary from build stage
COPY --from=build /home/toae/plugins/cloud-scanner/cloud_scanner /usr/local/bin/cloud_scanner
