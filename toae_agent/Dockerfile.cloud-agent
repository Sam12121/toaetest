# Use a base image with necessary tools
FROM golang:1.21-bookworm AS build

WORKDIR /home/toae/plugins/cloud-scanner
COPY plugins/cloud-scanner .

FROM debian:bookworm-slim AS ssl_builder

# Install OpenSSL
RUN apt-get update && apt-get install -y --no-install-recommends openssl && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /ssl

# Generate SSL certificate and key
RUN openssl genrsa -out nginx-selfsigned.key 2048 \
    && openssl req -new -key nginx-selfsigned.key -out nginx-selfsigned.csr \
    -subj "/C=US/ST=State/L=City/O=Organization/CN=localhost" \
    && openssl x509 -req -days 365 -in nginx-selfsigned.csr -signkey nginx-selfsigned.key -out nginx-selfsigned.crt

# Use a lighter base image for the final build
FROM debian:bookworm-slim

# Install required packages and copy SSL certificate and key from ssl_builder stage
RUN apt-get update && apt-get install -y --no-install-recommends nginx && rm -rf /var/lib/apt/lists/*
COPY --from=ssl_builder /ssl/nginx-selfsigned.crt /etc/nginx/nginx-selfsigned.crt
COPY --from=ssl_builder /ssl/nginx-selfsigned.key /etc/nginx/nginx-selfsigned.key

# Copy Nginx configuration files
COPY nginx.conf.template /etc/nginx/nginx.conf
COPY default.conf.template /etc/nginx/conf.d/default.conf

# Expose port 443 for HTTPS
EXPOSE 443

# Start Nginx
CMD ["nginx", "-g", "daemon off;"]

# Use a base image with necessary tools
FROM debian:bookworm-slim AS final_builder

# Install required packages
RUN apt-get update \
    && apt-get install -y --no-install-recommends bash git ca-certificates nano logrotate sudo \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Set environment variables
ENV DEEPFENCE_KEY=$TOAE_KEY \
    HOME_DIR="/home/toae" \
    COMPLIANCE_MOD_PATH="/opt/steampipe" \
    VERSION=2.1.0 \
    PUBLISH_CLOUD_RESOURCES_INTERVAL_MINUTES=5 \
    FETCH_CLOUD_RESOURCES_INTERVAL_HOURS=12

# Create directory /home/deepfence with correct permissions
RUN mkdir -p /home/deepfence && chown toae:root /home/deepfence

# Installing FluentBit
RUN echo '%sudo ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

# Copy scripts and configurations
COPY start_cloud_agent.sh /entrypoint.sh
COPY etc/fenced_logrotate.conf /etc/logrotate.d/logrotate.conf

# Change permissions
RUN chmod +x /entrypoint.sh /etc/logrotate.d/logrotate.conf

# Set working directory
WORKDIR /opt/steampipe

# Create symbolic link for /home/deepfence
RUN ln -s /home/toae /home/deepfence

# Set user
USER toae

# Entry point
ENTRYPOINT ["/entrypoint.sh"]
CMD ["/usr/local/bin/cloud_scanner"]
